# 1. Обзор безопасности

## 1_03. Кто такой хакер

Белые хакеры.  
Черные хакеры. Они делятся на многие группы.  

## 1_04. Тотальная безопасность недостижима

Уязвимость нулевого дня - разработчик или компания знали об этой проблеме ноль дней и ноль дней работали над ее решением.  

Общий уровень безопасности равен уровню безопасности самого уязвимого звена.  

<img src="img/secure_level.jpg" alt="drawing" width="600"/>

---

# 2. Главные принципы безопасности

## 2_01. Принцип наименьших привилегий

## 2_02. Чем проще - тем безопаснее

--  
Simple is More Secure

- Complexity invites bugs.
- Use clearly named functions and variables
Write code comments
- Break up long sections of code into small functions
- Don't repeat yourself

Простое более безопасно

- Сложность приводит к появлению ошибок.
- Используйте функции и переменные с четкими названиями
- Пишите комментарии к коду
- Разбивайте длинные участки кода на небольшие функции
- Не повторяйтесь

--  
Simple is More Secure

- Legacy code is a security concern
- Built-in functions are often better than your own versions
- Disable or remove unused features when possible

Простой - значит более безопасный

- Устаревший код - это проблема безопасности
- Встроенные функции часто лучше, чем ваши собственные версии
- По возможности отключайте или удаляйте неиспользуемые функции

## 2_03. Никогда не доверяйте юзерам
## 2_04. Ожидайте неожиданное
## 2_05. Глубокая защита

Это - многоуровневая защита.  

Области, куда это распространяется:  
- люди
- технологии, софт
- процедуры, отслеживание процессов, пошаговые инструкции

## 2_06. Безопасность через неясность

Чем меньше информации вы даете, тем лучше.  

## 2_07. Черные и белые списки

Черный список - действия, которые запрещены администратором системы.  
Белый список - действия, которые разрешены администратором системы.  
Более безопасный подход - создавать белые списки: только то, что разрешено.  

## 2_08. Точки взаимодействия и каналы передачи данных

В Блокноте или спец софте следует накидать путь, который проходят данные: входные и выходные доступные точки.

---
# 3. Фильтрация входных и контроль выходных данных

## 3_01. Регламентация HTTP запросов

Допускать только те запросы, которые ожидаются: Get, POST.

## 3_02. Валидация входных данных

Фильтруем входные данные в соотвествии с ожидаемыми типами и характеристиками.

## 3_03. Дезинфекция данных

Следует  
- явно приводить типы переменных к нужному типу вместо позволения языку жонглировать типами в фоне  
- использовать html-сущности, например `&lt;` вместо знака `<`  
- экранировать данные, например, обратным слэшем перед значением: `'\`  
- использовать встроенные функции языка  

## 3_04. Называем переменные правильно и ясно

До дезифекции переменные можно называть:  

    dirty, raw, tainted, unsafe.

После дезифекции переменные можно называть: 

    clean, filtered, sanitized, safe

Пример на PHP:  

```php    
    $raw_email = $_POST['email'];
    $safe_email = sanitize($raw_email);
    
    // или более сокращённо
    $safe_email = sanitize($_POST['email']);
```

## 3_05. Сохраняем приватность кода

Следует создавать папки

    /private
    /public

и чаще использовать функции, спрятанные в `private`. В `public`, таким образом, следует оставлять только "скучный код", и тогда не страшно, если он вдруг станет доступен, например из-за ошибок работы веб-страницы.

Также следует настроить конфигурацию веб-сервера:

- указать корневой каталог для публичной зоны
- поставить доступность и недоступность других папок, например, с помощью .htaccess

## 3_06. Сохраняем приватность учетных данных

Логины и пароли, которые используются рабочим кодом для доступа к различным ресурсам (БД, платежные системы), следует размещать в отдельном файле, и потом ссылаться на него из кода.  
Файл следует оградить от системы контроля версий.

Не использовать одинаковые пароли.  

Пароли надо хранить зашифрованными (hashed).  
Следует использовать принципы открытого и закрытого ключа для доступа к паролям.  

## 3_07. Выводите расплывчатые сообщения об ошибках

Полезно настроить вывод собственных страниц с ошибками. При этом не обязательно указывать, какая именно ошибка произошла - с сервером или приложением.  
Ошибки полезно отправлять по почте или в лог-файлы вместо того, чтобы выводить их на экран.  

## 3_08. Умное логирование

Логируйте
- ошибки
- важные действия
- всё подозрительное

Необходимые данные:
- время
- источник (user, IP)
- действия
- цель
- Куки/Сессии
- URL и все его параметры
- Обратная трассировка

Не логируйте
- важные данные (пароли, ключи, токены)

Сохраняйте старый контент
- контент под версионированием
- мягкое удаление

---
# 4. Наиболее распространенные атаки

## 4_01. Межсайтовый скриптинг (XSS)

Код внедряется через чужой Javascript.  
Возможность: получить данные куков, и, в итоге, сессии.

Данные, выводимые на экран, получаемые из форм, гет-запросов (Url), куков, сессии или БД, нужно санитаризировать.

## 4_02. Межсайтовая подделка запросов (CSRF)

Используйте POST для передачи и установления важных данных. Его нельзя передать в Get, а следовательно, тогда нельзя подловить пользователя неразлогинившегося на важном сайте с помощью вредоносного кода, встроенного на иной сайт.

Также для предотвращения CSRF используют токены формы. При генерации формы сохраняют значение токена в форму и в сессию. Потом сравнивают, когда форма будет получена.  
Также можно сохранить в сессию срок действия токена (1 день, например).  

## 4_03. Что такое SQL инъекция

Необходимо:

- давать ограниченные возможности пользователю БД в приложении
- дезинфекция входных данных
- экранирование запроса SQL (перед одинарной кавычкой обратный слэш)
- подготовленные запросы SQL

## 4_04. Манипуляции с URL

Необходимо:

- реализовать доступ к страницам по логину и паролю
- сообщать расплывчатые ошибки на страницах 
- GET запросы не должны ничего менять (идемпотентны)
- Для создания изменений - POST запросы 

## 4_05. Подмена форм и HTTP запросов

> Подделка заголовков запроса

Как предотвратить подделку заголовков запроса? - Никак. Просто нужно учитывать это при применении других мер безопасности.  

> Подделка форм

- Форма может быть скопирована на собственную страницу, и она будет работать как оригинальная

Однако на собственной странице теперь можно:
- Добавлять или удалять значения полей
- Редактировать скрытые поля
- Удалять проверки валидации на стороне клиента (Javascript в браузере)

> Как защититься от подделки форм

- Осознать, что их можно подделать, и нельзя полагаться на их внутреннюю валидацию, особенно это касается скрытых полей
- Нельзя доверять валидации на стороне клиента
- Следует проверять заголовок Referer, чтобы контролировать, откуда была отправлена форма. Но следует помнить, что заголовок тоже может быть подделан.  
- Использовать методы CSRF - токены, метки времени.

## 4_06. Доступность Cookie и их кража

Куки можно украть с помощью 
- Межсайтовый скриптинг (XSS)
- Украв заголовки

Защита:  
- не хранить важное у куках. Можно хранить настройки сайта (язык, громкость).
- использовать HttpOnly cookies. Это делает куки недоступными для Javascript и предотвращает встраивание Javascript метода `document.cookie`
- использовать защищенные куки Secure cookies (HTTPS only)
- ограничивать время жизни куков
- можно задать домен, поддомен и путь, где куки должны работать

## 4_07. Взлом сессии

Сессии передают свои значения или id через куки в браузер. Украсть можно id сессии.

Защита:

Средние:

- Проверка заголовка User-Agent. Хранить его значение в сессии и сравнивать с получаемым от клиента.  
  Однако браузреры у клиента и хакера могут совпасть, а заголовок можно подделать.  

- Проверка ip-адреса, с которого поступает запрос.   
  Однако, ip может меняться в процессе работы у легитимного пользователя. Или ip могут совпадать с другими или с  хакером.  

Надёжные:

- Использовать HttpOnly cookies.

- Периодически генерировать новые идентификаторы сессии.

- Регулярное удаление старых файлов сессии. Отслеживать неактивные сессии и удалять их.  

Самые надёжные:

- Использовать SSL.

- Использовать защищенные куки Secure cookies, тогда куки будут отправлять только по SSL.

## 4_08. Фиксация сессии

Противоположно краже (взлому) сессии. Здесь сессия  не крадётся, а навязывается. Хакер высылает свой идентификатор сессии юзеру.  

Большинство атак фиксации сессии расчитывают на то, что id сессии будет принят через url или POST данных.

Защита:
- не принимайте id сессии из переменных POST и GET
- идентификаторы должны приниматься только из кукис
- периодически генерировать новые id сессии, особенно в важные моменты, например, после авторизации юзера
- регулярно удалять старые файлы id сессии, которые уже не активны

## 4_09. Удаленное управление сервером

Это самя опасная атака. Получить доступ к северу сложно. Обычно языки программирования не могут получить доступ к ОС. Но существуют ключевые слова в языках программирования, которые могут быть использованы с ОС и с которыми нужно быть осторожными.

    system exec shell
    sh
    shell_exec
    open
    popen
    proc_open
    call subprocess spawn passthru eval
    %X
    `
Защита:

- избегать использования этих команд
- или использовать их с осторожностью
- всегда санитизировать, экранировать их
- полностью понимать их синтаксис
- использовать дополнительные валидации данных

## 4_10. Злоупотребление загрузкой файлов (Upload)

Атака заключается в том, что файлы загружаются на сервер в вечном цикле, забивая место на сервере, что может привести к заторможенности или остановке сервера.  
Также возможна загрузка вредоносного файла на сервер.  

Защита:
- загрузка только после аутентификации пользователя
- лимиты на максимальный размер файла
- лимиты на количество файлов от одного юзера
- лимиты на форматы и расширения файлов
- осторожно при открытии загруженных кем-то файлов
- загруженные файлы нужно проверять, верифицировать перед выкладкой на сайт

## 4_11. Что такое DoS атака 

Отказ в олбслуживании (Denial of Service) - сервер перестаёт отвечать на запросы из-за множества направленных на него запросов (или на DNS, или на пропускную способность).   
Вариация - с распределенной сетью компьютеров - Distributed Denial of Service (DDoS).  

Защита:  
- Firewall - ограничения по портам, ip
- Коммутаторы (switches) и маршрутизаторы (routers) - ограничения скорости и фильтрации (списки контроля доступа)
- Управление нагрузкой оборудования и софта 
- Обратный прокси-сервер
- Наличие карты инфраструктуры (где находятся firewall, маршрутизаторы)
- Актуальное состояние инфраструктуры (обновлены)
- Высококачественный хостинг и оборудование
- Сделать сетевой трафик видимым  
- План реагирования  
  - Возможность сменить ip адрес сервера
  - Пустить трафик в "черную дыру" - блокировка всего входящего трафика
- Будьте хорошими: DoS атаки не извлекают финансовой прибыли и обычно вызваны личной неприязнью к вам или вашему сайту.

# 5. Шифрование и аутентификация

## 5_01. Шифрование паролей

- Не хранить пароли как простой текст
- Применять однонаправленное (в одну сторону) шифрование пароля
- Ренкомендуется алгоритм хэширования Blowfish

## 5_02. Пароли с солью

