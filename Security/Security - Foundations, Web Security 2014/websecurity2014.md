# 1. Обзор безопасности

## 1_03. Кто такой хакер

Белые хакеры.  
Черные хакеры. Они делятся на многие группы.  

## 1_04. Тотальная безопасность недостижима

Уязвимость нулевого дня - разработчик или компания знали об этой проблеме ноль дней и ноль дней работали над ее решением.  

Общий уровень безопасности равен уровню безопасности самого уязвимого звена.  

<img src="img/secure_level.jpg" alt="drawing" width="600"/>

---

# 2. Главные принципы безопасности

## 2_01. Принцип наименьших привилегий

## 2_02. Чем проще - тем безопаснее

--  
Simple is More Secure

- Complexity invites bugs.
- Use clearly named functions and variables
Write code comments
- Break up long sections of code into small functions
- Don't repeat yourself

Простое более безопасно

- Сложность приводит к появлению ошибок.
- Используйте функции и переменные с четкими названиями
- Пишите комментарии к коду
- Разбивайте длинные участки кода на небольшие функции
- Не повторяйтесь

--  
Simple is More Secure

- Legacy code is a security concern
- Built-in functions are often better than your own versions
- Disable or remove unused features when possible

Простой - значит более безопасный

- Устаревший код - это проблема безопасности
- Встроенные функции часто лучше, чем ваши собственные версии
- По возможности отключайте или удаляйте неиспользуемые функции

## 2_03. Никогда не доверяйте юзерам
## 2_04. Ожидайте неожиданное
## 2_05. Глубокая защита

Это - многоуровневая защита.  

Области, куда это распространяется:  
- люди
- технологии, софт
- процедуры, отслеживание процессов, пошаговые инструкции

## 2_06. Безопасность через неясность

Чем меньше информации вы даете, тем лучше.  

## 2_07. Черные и белые списки

Черный список - действия, которые запрещены администратором системы.  
Белый список - действия, которые разрешены администратором системы.  
Более безопасный подход - создавать белые списки: только то, что разрешено.  

## 2_08. Точки взаимодействия и каналы передачи данных

В Блокноте или спец софте следует накидать путь, который проходят данные: входные и выходные доступные точки.

---
# 3. Фильтрация входных и контроль выходных данных

## 3_01. Регламентация HTTP запросов

Допускать только те запросы, которые ожидаются: Get, POST.

## 3_02. Валидация входных данных

Фильтруем входные данные в соотвествии с ожидаемыми типами и характеристиками.

## 3_03. Дезинфекция данных

Следует  
- явно приводить типы переменных к нужному типу вместо позволения языку жонглировать типами в фоне  
- использовать html-сущности, например `&lt;` вместо знака `<`  
- экранировать данные, например, обратным слэшем перед значением: `'\`  
- использовать встроенные функции языка  

## 3_04. Называем переменные правильно и ясно

До дезифекции переменные можно называть:  

    dirty, raw, tainted, unsafe.

После дезифекции переменные можно называть: 

    clean, filtered, sanitized, safe

Пример на PHP:  

```php    
    $raw_email = $_POST['email'];
    $safe_email = sanitize($raw_email);
    
    // или более сокращённо
    $safe_email = sanitize($_POST['email']);
```

## 3_05. Сохраняем приватность кода

Следует создавать папки

    /private
    /public

и чаще использовать функции, спрятанные в `private`. В `public`, таким образом, следует оставлять только "скучный код", и тогда не страшно, если он вдруг станет доступен, например из-за ошибок работы веб-страницы.

Также следует настроить конфигурацию веб-сервера:

- указать корневой каталог для публичной зоны
- поставить доступность и недоступность других папок, например, с помощью .htaccess

## 3_06. Сохраняем приватность учетных данных

Логины и пароли, которые используются рабочим кодом для доступа к различным ресурсам (БД, платежные системы), следует размещать в отдельном файле, и потом ссылаться на него из кода.  
Файл следует оградить от системы контроля версий.

Не использовать одинаковые пароли.  

Пароли надо хранить зашифрованными (hashed).  
Следует использовать принципы открытого и закрытого ключа для доступа к паролям.  

## 3_07. Выводите расплывчатые сообщения об ошибках

Полезно настроить вывод собственных страниц с ошибками. При этом не обязательно указывать, какая именно ошибка произошла - с сервером или приложением.  
Ошибки полезно отправлять по почте или в лог-файлы вместо того, чтобы выводить их на экран.  

## 3_08. Умное логирование

Логируйте
- ошибки
- важные действия
- всё подозрительное

Необходимые данные:
- время
- источник (user, IP)
- действия
- цель
- Куки/Сессии
- URL и все его параметры
- Обратная трассировка

Не логируйте
- важные данные (пароли, ключи, токены)

Сохраняйте старый контент
- контент под версионированием
- мягкое удаление

---
# 4. Наиболее распространенные атаки

## 4_01. Межсайтовый скриптинг (XSS)

Код внедряется через чужой Javascript.  
Возможность: получить данные куков, и, в итоге, сессии.

Данные, выводимые на экран, получаемые из форм, гет-запросов (Url), куков, сессии или БД, нужно санитаризировать.

## 4_02. Межсайтовая подделка запросов (CSRF)

Используйте POST для передачи и установления важных данных. Его нельзя передать в Get, а следовательно, тогда нельзя подловить пользователя неразлогинившегося на важном сайте с помощью вредоносного кода, встроенного на иной сайт.

Также для предотвращения CSRF используют токены формы. При генерации формы сохраняют значение токена в форму и в сессию. Потом сравнивают, когда форма будет получена.  
Также можно сохранить в сессию срок действия токена (1 день, например).  

## 4_03. Что такое SQL инъекция

Необходимо:

- давать ограниченные возможности пользователю БД в приложении
- дезинфекция входных данных
- экранирование запроса SQL (перед одинарной кавычкой обратный слэш)
- подготовленные запросы SQL

## 4_04. Манипуляции с URL

Необходимо:

- реализовать доступ к страницам по логину и паролю
- сообщать расплывчатые ошибки на страницах 
- GET запросы не должны ничего менять (идемпотентны)
- Для создания изменений - POST запросы 

## 4_05. Подмена форм и HTTP запросов

> Подделка заголовков запроса

Как предотвратить подделку заголовков запроса? - Никак. Просто нужно учитывать это при применении других мер безопасности.  

> Подделка форм

- Форма может быть скопирована на собственную страницу, и она будет работать как оригинальная

Однако на собственной странице теперь можно:
- Добавлять или удалять значения полей
- Редактировать скрытые поля
- Удалять проверки валидации на стороне клиента (Javascript в браузере)

> Как защититься от подделки форм

- Осознать, что их можно подделать, и нельзя полагаться на их внутреннюю валидацию, особенно это касается скрытых полей
- Нельзя доверять валидации на стороне клиента
- Следует проверять заголовок Referer, чтобы контролировать, откуда была отправлена форма. Но следует помнить, что заголовок тоже может быть подделан.  
- Использовать методы CSRF - токены, метки времени.

## 4_06. Доступность Cookie и их кража

Куки можно украть с помощью 
- Межсайтовый скриптинг (XSS)
- Украв заголовки

Защита:  
- не хранить важное у куках. Можно хранить настройки сайта (язык, громкость).
- использовать HttpOnly cookies. Это делает куки недоступными для Javascript и предотвращает встраивание Javascript метода `document.cookie`
- использовать защищенные куки Secure cookies (HTTPS only)
- ограничивать время жизни куков
- можно задать домен, поддомен и путь, где куки должны работать

## 4_07. Взлом сессии

Сессии передают свои значения или id через куки в браузер. Украсть можно id сессии.

Защита:

Средние:

- Проверка заголовка User-Agent. Хранить его значение в сессии и сравнивать с получаемым от клиента.  
  Однако браузреры у клиента и хакера могут совпасть, а заголовок можно подделать.  

- Проверка ip-адреса, с которого поступает запрос.   
  Однако, ip может меняться в процессе работы у легитимного пользователя. Или ip могут совпадать с другими или с  хакером.  

Надёжные:

- Использовать HttpOnly cookies.

- Периодически генерировать новые идентификаторы сессии.

- Регулярное удаление старых файлов сессии. Отслеживать неактивные сессии и удалять их.  

Самые надёжные:

- Использовать SSL.

- Использовать защищенные куки Secure cookies, тогда куки будут отправлять только по SSL.

## 4_08. Фиксация сессии

Противоположно краже (взлому) сессии. Здесь сессия  не крадётся, а навязывается. Хакер высылает свой идентификатор сессии юзеру.  

Большинство атак фиксации сессии расчитывают на то, что id сессии будет принят через url или POST данных.

Защита:
- не принимайте id сессии из переменных POST и GET
- идентификаторы должны приниматься только из кукис
- периодически генерировать новые id сессии, особенно в важные моменты, например, после авторизации юзера
- регулярно удалять старые файлы id сессии, которые уже не активны

## 4_09. Удаленное управление сервером

Это самя опасная атака. Получить доступ к северу сложно. Обычно языки программирования не могут получить доступ к ОС. Но существуют ключевые слова в языках программирования, которые могут быть использованы с ОС и с которыми нужно быть осторожными.

    system exec shell
    sh
    shell_exec
    open
    popen
    proc_open
    call subprocess spawn passthru eval
    %X
    `
Защита:

- избегать использования этих команд
- или использовать их с осторожностью
- всегда санитизировать, экранировать их
- полностью понимать их синтаксис
- использовать дополнительные валидации данных

## 4_10. Злоупотребление загрузкой файлов (Upload)

Атака заключается в том, что файлы загружаются на сервер в вечном цикле, забивая место на сервере, что может привести к заторможенности или остановке сервера.  
Также возможна загрузка вредоносного файла на сервер.  

Защита:
- загрузка только после аутентификации пользователя
- лимиты на максимальный размер файла
- лимиты на количество файлов от одного юзера
- лимиты на форматы и расширения файлов
- осторожно при открытии загруженных кем-то файлов
- загруженные файлы нужно проверять, верифицировать перед выкладкой на сайт

## 4_11. Что такое DoS атака 

Отказ в олбслуживании (Denial of Service) - сервер перестаёт отвечать на запросы из-за множества направленных на него запросов (или на DNS, или на пропускную способность).   
Вариация - с распределенной сетью компьютеров - Distributed Denial of Service (DDoS).  

Защита:  
- Firewall - ограничения по портам, ip
- Коммутаторы (switches) и маршрутизаторы (routers) - ограничения скорости и фильтрации (списки контроля доступа)
- Управление нагрузкой оборудования и софта 
- Обратный прокси-сервер
- Наличие карты инфраструктуры (где находятся firewall, маршрутизаторы)
- Актуальное состояние инфраструктуры (обновлены)
- Высококачественный хостинг и оборудование
- Сделать сетевой трафик видимым  
- План реагирования  
  - Возможность сменить ip адрес сервера
  - Пустить трафик в "черную дыру" - блокировка всего входящего трафика
- Будьте хорошими: DoS атаки не извлекают финансовой прибыли и обычно вызваны личной неприязнью к вам или вашему сайту.

# 5. Шифрование и аутентификация

## 5_01. Шифрование паролей

- Не хранить пароли как простой текст
- Применять однонаправленное (в одну сторону) шифрование пароля
- Ренкомендуется алгоритм хэширования Blowfish

## 5_02. Пароли с солью

Радужные таблицы - предварительно вычисленные  таблицы с заданным методом шифрования.  

Защита:
- соль - дополнительная строка перед зашифрованной строкой пароля, например:

      "Put salt on the {$password}"

- уникальная соль, например:  

      "Put salt on the {$password} for {$username}"

- случайная соль

      "Put salt on the {$password} at ".time()

Соль нужно хранить в БД, но ее нужно тоже хэшировать.  

Метод шифрования Blowfish автоматически добавляет соль перед паролем.  

## 5_03. Требования к паролю

Требуются:  

- Минимальная длина, но не ограничивать максимальную
- Небуквенные и нециферные символы
- Подтверждение пароля при регистрации

Желательно:

- Уведомлять о надежности пароля во время его ввода
- Не просить установить подсказу о пароле. Некоторые введут еще раз свой пароль. 
- Установить ответ на секретный вопрос.
- Пользоваться сайтами или библиотеками, проверяющими надежность пароля.  

## 5_04. Брутфорс атаки

Это - полный перебор всех вариантов при взломе пароля, "полный перебор ключей".

Формула полного требуемого времени на перебор ключей:

$ KeySpace^{Key Length}  *  Time Per Attempt = Time Required $

    Пространство Ключа (в степени Длина Ключа) x Время на одну попытку = Всё требуемое время

, где   
Пространство Ключа - число возможных вариаций для каждого символа ключа,  
Длина Ключа - количество длины ключа (длина пароля).

Защита:
- Пространство Ключа нужно сделать как можно больше (использовать все возможные символы)
- Длина Ключа должна быть как можно длинее
- Время на одну попытку - увеличивать. Например, алгоритм шифрования Blowfish - медленный. Также можно увеличить время, например, принимать 1 пароль от пользователя за 2 секунды. 

- Требовать разнообразные символы в пароле
- Требовать минимальную длину пароля
- Блокировка аккаунта (на 5-10 минут) после нескольких попыток (например, 20) неудачного перебора
- Вести логи входа в аккаунт либо неудачные попытки
- Черный список - бан для ip-адресов, отправляющих слишком много запросов.

## 5_05. Использование SSL

Сейчас используется на каждой странице.  

## 5_06. Защита Cookie

Куки уязвимы к краже, взлому сессии и фиксации сессии.   

Защита:
- Использовать HttpOnly cookies. Это гаранитрует, что к кукам нет доступа через Javascript.
- Периодически регенерировать новые идентификаторы сессии, особенно в ключевые моменты, например, после входа в аккаунт.  
- Регулярно удалять старые или истекшие файлы сессии.  
- Не принимать id сессии, пришедшие из GET или POST переменных.  
- Использовать SSL.
- Установить в куках атрибут Secure cookies. Так куки будут передаваться только по SSL.    
- Ограничить срок действия авторизации (например, день или неделя). С этим вместе необходимо ограничить срок действия куки и файла сессии.  

## 5_07. Управление привилегиями (правами доступа)

Рекомендуемые принципы:

- принцип наименьших привилегий
- вы должны быть организованы
- сделайте процесс аннулирования привилегий легким
- ограничить доступ к инструментам назначения привилегий доступа
- разделять привилегии крупными частями, например, по зонам привилегий: назначить, какие привилегии относятся к категориям и группам ответственности
- можно назначить уровни привилегий (1,2,3,4,5, или Старший админ, админ, младший админ, персонал, пользователи, или Издатель, Писатель, Редактор, Дизайнер, Графический редактор)
- относительно клиентов можно разделить их по группам, кто больше потратил денег, и от этого раздавать привилегии

## 5_08. Как справляться с забытыми паролями

Как идентифицировать пользователя, запрашивающего новый пароль.

- Спросить у него конфиденциальную информацию, например, на сайте банка это могут быть номер карты и пин-код
- Задать ряд контрольных вопросов безопасности. Это могут быть вопрсы, заранее заданные пользователем, или вопросы о поведении пользователя на сайте.
- Нанять персонал, работающий с этими вопросами, чтобы не делать этого в автоматическом режиме
- Отправить email с новым паролем
- Отправить email с токеном сброса пароля

Отправка токена по шагам:
- Пользователь отправляет запрос на сброс пароля и отправляет свой логин
- На это всегда отвечается положительно - да, сейчас мы сбросим ваш пароль
- Мы генерируем токен длиной 40 символов и сохраняем его в БД
- Токен ограничивается по времени существования
- Далее мы отправляем по email url, который содержит токен
- Пользователь переходит по ссылке, открывается страница, на которой сверится токен пользователя с токеном в БД. Если они совпадают, пользователю будет предоставлена возможность задать новый пароль. 

В подходе с токеном, старый пароль не уничтожается сразу при запросе о забытом пароле, а действует до момента его замены пользователем.

## 5_09. Мульти-факторная аутентификация (MFA)

Мульти-факторная аутентификация запрашивает как минимум два фактора из указанных категорий:
- то, что только юзер знает (например, PIN, CVV, код)
- то, что только юзер имеет (например, пластиковая банковская карта, определенный компьютер)
- то, что только у юзера есть (как правило, биометрия)

Распространённые способы запросов второго фактора аутентификации:  
- отправка письма на email пользователя с кодом для ввода или URL для перехода
- отправка смс пользователю с кодом для ввода или с требованием отправить некое сообщение в ответ  
- голосовое сообщение пользователю с кодом или требованием ответа

# 6. Другие проблемные области

## 6_01. Платежи по кредитным картам

Стандарты безопасности PCI - Payment Card Industry

https://www.pcisecuritystandards.org/

Некоторые правила:

- SSL
- Не хранить полные номера кредитных карт
- Не хранить CVV
- Хранить брэнд и 4 последние цифры карт

Отдельный сервис (платёжный процессор) хранилища карт позволяет хранить данные карт и получать эти данные по особому токену. Этот токен работает только между вами и процессором, кража токена ни к чему не ведёт.  

## 6_02. Недостатки регулярных выражений

В регулярных выражениях легко допустить ошибку. Ошибка может быть использована хакером.

## 6_03. Преобразование данных

После преобразования данных в другой формат данные следует заново санитизировать.  

## 6_04. Переполнение буфера (Buffer overflows)

Переполнение памяти обычно возможно в низкоуровневых языках: C, C++, Objective-C. Но даже языки высокого уровня (Java,PHP,Ruby,Perl,Python) могут ссылаться на библиотеки C или C++.  

Решение в С-подобных языках:
- использовать память аккуратно
- использовать простые строковые функции
- валидировать данные, точно устанавливать исходящие и входящие параметры данных.

## 6_05. Системы контроля версий

Защита

- Решить, проект должен быть приватный или публичный
- Выдавать права доступа по принципу наименьших привилегий
- Никогда не коммитить базы данных, учетные данные, токены, хэши. Эти данные должны храниться в простых файлах, которые должны быть игнорированы системой контроля версий.  

## 6_06. Безопасность базы данных

Защита

- Пароль у root должен быть задан
- Подключайтесь другим пользователем - не root
- У него не должно быть прав на изменение прав у других пользователей
- Разрешить доступ к БД только с localhost или определенных IP
- Регулярно делать бэкап данных
- Чтобы в случае физических поломок не потерять и БД, и бэкап, хранить бэкапы на разных защищённых серверах.
- Бэкап должен быть защищён (закрыт), как и БД.
- Прописать в корпроративной политике безопасности инструкцию по обращению с бэкапами.
- Бэкапы не должны храниться хостингами на серверах, где нет доступа к бэкапам.

## 6_07. Безопасность сервера

- Отключить или защитить root пользователя
- Настроить права доступа по принципу наименьших привилегий. Периодически пересматривать права. Защитить также суперпользователя (sudo).
- Использовать SSH ключи. 
- Можно изменить номера портов, но не стоит менять порт 80 для HTTP.
- Использовать Firewall
- Знать свой сервер
- Обновлять софт
- Отключить или удалить всё, что не нужно

---
